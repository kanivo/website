<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    #backButton, #refToggleButton, #shuffleButton, #repeatButton {
      padding: 10px;
      background-color: white;
      color: black;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    #backButton, #refToggleButton {
      position: absolute;
      top: 20px;
    }
    #backButton { left: 20px; }
    #refToggleButton { right: 20px; }

    #shuffleButton, #repeatButton {
      margin: 10px auto 20px auto;
      display: block;
    }

    #backButton:hover, #refToggleButton:hover, #shuffleButton:hover, #repeatButton:hover {
      background-color: #6b00b3;
      color: white;
    }

    h1, p {
      color: white;
      text-align: center;
    }

    .song-list {
      list-style-type: none;
      padding: 0;
      margin: 0 auto 120px auto;
      width: 320px;
      flex: 1;
    }

    .song-item-wrapper {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .song-number {
      color: white;
      margin-right: 10px;
      width: 20px;
      text-align: right;
    }

    .song-item {
      background-color: #333;
      border: 1px solid #444;
      padding: 10px;
      cursor: pointer;
      width: 100%;
      text-align: center;
      flex-grow: 1;
      color: white;
    }

    .song-item:hover {
      background-color: #555;
    }

    .song-item.active {
      background-color: #6b00b3;
      font-weight: bold;
    }

    /* Bottom player controls */
    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #111;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
      z-index: 10;
    }

    .controls button {
      padding: 10px;
      font-size: 18px;
      background-color: #333;
      color: white;
      border: none;
      cursor: pointer;
    }

    .controls button.active {
      background-color: #6b00b3;
    }

    #progressBar {
      flex: 1;
      height: 8px;
      background: #333;
      accent-color: #6b00b3;
      cursor: pointer;
      border-radius: 4px;
      min-width: 150px;
    }
  </style>
</head>
<body>

  <button id="backButton" onclick="window.location.href='./'">Back</button>
  <button id="refToggleButton">swap</button>

  <h1>sqworm</h1>
  <p>boo spotify premium</p>

  <button id="shuffleButton">Shuffle: ON</button>
  <button id="repeatButton">Repeat: OFF</button>

  <ul class="song-list" id="song-list"></ul>

  <div class="controls">
    <button id="prevButton">⏮</button>
    <button id="playPauseButton">▶️</button>
    <button id="nextButton">⏭</button>
    <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
  </div>

  <audio id="audio-player" preload="metadata"></audio>

  <script>
    let songs = [];
    let currentSongIndex = 0;
    let isShuffle = true;
    let isRepeat = false;
    let playHistory = [];
    let forwardHistory = [];
    let isRefMode = false;
    let isPlaying = false;

    const audioPlayer = document.getElementById('audio-player');
    const playPauseButton = document.getElementById('playPauseButton');
    const nextButton = document.getElementById('nextButton');
    const prevButton = document.getElementById('prevButton');
    const progressBar = document.getElementById('progressBar');
    const shuffleButton = document.getElementById('shuffleButton');
    const repeatButton = document.getElementById('repeatButton');
    const songListElement = document.getElementById('song-list');
    const refToggleButton = document.getElementById('refToggleButton');

    function updateActiveSong() {
      document.querySelectorAll('.song-item').forEach((el, idx) => {
        el.classList.toggle('active', idx === currentSongIndex);
      });
    }

    function playSong(index, { fromHistory = false } = {}) {
      if (index >= songs.length) index = 0;
      if (index < 0) index = songs.length - 1;

      if (!fromHistory) {
        playHistory.push(currentSongIndex);
        forwardHistory = [];
      }

      currentSongIndex = index;
      const song = songs[currentSongIndex];
      audioPlayer.src = song.file;
      audioPlayer.play();
      updateActiveSong();
    }

    function getNextSongIndex() {
      return isShuffle ? Math.floor(Math.random() * songs.length) : currentSongIndex + 1;
    }

    function loadSongs(file) {
      fetch(file)
        .then(response => response.json())
        .then(data => {
          songs = data;
          currentSongIndex = 0;
          playHistory = [];
          forwardHistory = [];
          songListElement.innerHTML = '';

          songs.forEach((song, index) => {
            const wrapper = document.createElement('div');
            wrapper.classList.add('song-item-wrapper');

            const number = document.createElement('span');
            number.classList.add('song-number');
            number.textContent = `${index + 1}.`;

            const item = document.createElement('li');
            item.classList.add('song-item');
            item.textContent = `${song.title} (${song.artist})`;

            item.addEventListener('click', () => playSong(index));

            wrapper.appendChild(number);
            wrapper.appendChild(item);
            songListElement.appendChild(wrapper);
          });

          updateActiveSong();
        })
        .catch(error => console.error('Error loading song data:', error));
    }

    loadSongs('assets/data.json');

    // Play/Pause
    playPauseButton.addEventListener('click', () => {
      if (isPlaying) audioPlayer.pause();
      else audioPlayer.play();
    });

    audioPlayer.addEventListener('play', () => {
      isPlaying = true;
      playPauseButton.textContent = '⏸';
    });

    audioPlayer.addEventListener('pause', () => {
      isPlaying = false;
      playPauseButton.textContent = '▶️';
    });

    // Progress bar
    audioPlayer.addEventListener('timeupdate', () => {
      if (audioPlayer.duration) {
        progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      }
    });

    progressBar.addEventListener('input', () => {
      if (audioPlayer.duration) {
        audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
      }
    });

    // Next/Prev
    prevButton.addEventListener('click', () => {
      if (isShuffle && playHistory.length > 0) {
        forwardHistory.push(currentSongIndex);
        playSong(playHistory.pop(), { fromHistory: true });
      } else {
        playSong(currentSongIndex - 1);
      }
    });

    nextButton.addEventListener('click', () => {
      if (isShuffle && forwardHistory.length > 0) {
        playHistory.push(currentSongIndex);
        playSong(forwardHistory.pop(), { fromHistory: true });
      } else {
        playSong(getNextSongIndex());
      }
    });

    // Shuffle/Repeat
    shuffleButton.addEventListener('click', () => {
      isShuffle = !isShuffle;
      shuffleButton.textContent = `Shuffle: ${isShuffle ? 'ON' : 'OFF'}`;
      shuffleButton.classList.toggle('active', isShuffle);
    });

    repeatButton.addEventListener('click', () => {
      isRepeat = !isRepeat;
      repeatButton.textContent = `Repeat: ${isRepeat ? 'ON' : 'OFF'}`;
      repeatButton.classList.toggle('active', isRepeat);
    });

    // Ref toggle
    refToggleButton.addEventListener('click', () => {
      isRefMode = !isRefMode;
      const newFile = isRefMode ? 'assets/refdata.json' : 'assets/data.json';
      loadSongs(newFile);
    });

    // Song ended
    audioPlayer.addEventListener('ended', () => {
      if (isRepeat) playSong(currentSongIndex, { fromHistory: true });
      else playSong(getNextSongIndex());
    });

    // Spacebar
    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        event.preventDefault();
        if (audioPlayer.paused) audioPlayer.play();
        else audioPlayer.pause();
      }
    });

  </script>
</body>
</html>
